name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
      # Trunk-based development: feature/*, fix/*, bugfix/*, release/* branches
      - 'feature/**'
      - 'fix/**'
      - 'bugfix/**'
      - 'release/**'
      - 'hotfix/**'
  pull_request:
    branches:
      - main
      - master
      # Allow PR checks from any branch to trunk branches
      - 'feature/**'
      - 'fix/**'
      - 'bugfix/**'
      - 'release/**'
      - 'hotfix/**'

env:
  AWS_REGION: ap-south-1
  PYTHON_VERSION: '3.11'
  # Trunk branch reference (used for conditional deployment)
  TRUNK_BRANCH: main

jobs:
  # ============================================================================
  # STAGE 1: BUILD & LINT
  # ============================================================================
  build:
    name: Build & Lint
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 black isort pytest pytest-cov
      
      - name: Lint with flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      
      - name: Check code formatting (black)
        run: black --check . || true
      
      - name: Check import sorting (isort)
        run: isort --check-only . || true
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: python-dependencies
          path: requirements.txt

  # ============================================================================
  # STAGE 2: UNIT TESTS
  # ============================================================================
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Run unit tests with coverage
        run: |
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=html || true
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
      
      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: pytest-results
          path: htmlcov/

  # ============================================================================
  # STAGE 3: SECURITY CHECKS
  # ============================================================================
  security:
    name: Security Checks
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install security tools
        run: |
          pip install bandit safety
      
      - name: Run Bandit (security linting)
        run: bandit -r . -f json -o bandit-report.json || true
      
      - name: Check for vulnerable dependencies
        run: safety check --json || true
      
      - name: Upload security reports
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: bandit-report.json

  # ============================================================================
  # STAGE 4: BUILD DOCKER IMAGE (Optional - for containerized deployment)
  # ============================================================================
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    # Build Docker on any push to trunk (main/master) or after successful PR merge
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
      
      - name: Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: langchain-agent
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker buildx build \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            --push \
            .

  # ============================================================================
  # STAGE 5: DEPLOY TO AWS
  # ============================================================================
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: [test, security]
    # Deploy only on trunk (main/master) branch pushes - not on feature branches
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Deploy to Lambda (example)
        run: |
          # Zip the application
          zip -r lambda-deployment.zip . -x "venv/*" "*.git/*" "__pycache__/*" "*.pyc"
          
          # Update Lambda function
          aws lambda update-function-code \
            --function-name langchain-agent-function \
            --zip-file fileb://lambda-deployment.zip \
            --region ${{ env.AWS_REGION }} || echo "Lambda function not found, skipping deployment"
      
      - name: Send deployment notification
        run: |
          echo "âœ… Deployment complete for commit ${{ github.sha }}"
          echo "Deployed to: ${{ env.AWS_REGION }}"

  # ============================================================================
  # STAGE 6: INTEGRATION TESTS ON AWS
  # ============================================================================
  integration-test:
    name: Integration Tests on AWS
    runs-on: ubuntu-latest
    needs: deploy
    # Run integration tests after successful deployment on trunk
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest requests
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Run integration tests
        env:
          LLM_PROVIDER: perplexity
        run: |
          pytest tests/integration/ -v --tb=short || true
      
      - name: Upload integration test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: integration-test-results
          path: test-results/
